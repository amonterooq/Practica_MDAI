<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NADA | Inventario</title>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&family=Playfair+Display:wght@400;700&display=swap" rel="stylesheet">

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" th:href="@{/css/prenda.css}">
    <link rel="stylesheet" th:href="@{/css/chat-widget.css}">
</head>
<body>

<nav class="navbar">
    <div class="nav-container">
        <a href="/" class="logo">NADA<span class="dot">.</span></a>
        <ul class="nav-links">
            <li><a th:href="@{/posts/}">Posts</a></li>
            <li><a th:href="@{/armario/}" class="active">Mi Armario</a></li>
            <li><a th:href="@{/conjuntos/}">Conjuntos</a></li>
            <li><a th:href="@{/usuarios/perfil}">Perfil</a></li>
            <li>
                <a th:href="@{/usuarios/logout}" class="btn-link">Salir</a>
            </li>
        </ul>
    </div>
</nav>

<main class="main-container">

    <aside class="upload-panel">
        <div class="panel-header">
            <h2>Nuevo Art칤culo</h2>
            <p>A침ade una prenda individual.</p>
        </div>

        <div th:if="${error != null}" style="margin-bottom:0.8rem; color:#c0392b; font-size:0.8rem;">
            <span th:text="${error}">Error</span>
        </div>
        <div th:if="${success != null}" style="margin-bottom:0.8rem; color:#27ae60; font-size:0.8rem;">
            <span th:text="${success}">OK</span>
        </div>

        <form th:action="@{/armario/crear}" method="post" enctype="multipart/form-data">

            <!-- 1. Nombre -->
            <div class="form-group">
                <label>Nombre</label>
                <input type="text" name="nombre" placeholder="Ej. Camisa Blanca" required>
            </div>

            <!-- 2. Tipo de prenda -->
            <div class="form-group">
                <label>Tipo de Prenda</label>
                <select id="tipoPrendaSelect" name="tipoPrenda" onchange="mostrarCategorias()" required>
                    <option value="">-- Seleccionar --</option>
                    <option value="superior">Parte Superior</option>
                    <option value="inferior">Parte Inferior</option>
                    <option value="calzado">Calzado</option>
                </select>
            </div>

            <!-- 3. Categor칤a (seg칰n tipo) -->
            <div id="divCatSuperior" class="form-group hidden">
                <label>Categor칤a</label>
                <select name="catSuperior">
                    <option value="">-- Seleccionar --</option>
                    <option th:each="cat : ${categoriasSuperior}" th:value="${cat}" th:text="${cat.etiqueta}"></option>
                </select>
            </div>

            <div id="divCatInferior" class="form-group hidden">
                <label>Categor칤a</label>
                <select name="catInferior">
                    <option value="">-- Seleccionar --</option>
                    <option th:each="cat : ${categoriasInferior}" th:value="${cat}" th:text="${cat.etiqueta}"></option>
                </select>
            </div>

            <div id="divCatCalzado" class="form-group hidden">
                <label>Categor칤a</label>
                <select name="catCalzado">
                    <option value="">-- Seleccionar --</option>
                    <option th:each="cat : ${categoriasCalzado}" th:value="${cat}" th:text="${cat.etiqueta}"></option>
                </select>
            </div>

            <!-- 4. Talla -->
            <div id="divTalla" class="form-group hidden">
                <label>Talla</label>
                <select id="tallaSelect" name="talla" required>
                    <option value="">-- Seleccionar --</option>
                </select>
            </div>

            <!-- 5. Marca -->
            <div class="form-group">
                <label>Marca</label>
                <select id="marcaSelect" name="marcaSeleccionada">
                    <option value="">-- Seleccionar --</option>
                    <option th:each="marca : ${marcas}" th:value="${marca.etiqueta}" th:text="${marca.etiqueta}"></option>
                </select>
                <input type="text" id="marcaOtraInput" placeholder="Escribe la marca" style="margin-top:0.5rem; display:none;">
                <!-- Campo oculto real que se env칤a al backend -->
                <input type="hidden" id="marcaFinal" name="marca">
            </div>

            <!-- 6. Color -->
            <div class="form-group">
                <label>Color</label>
                <select id="colorSelect" name="colorSeleccionado">
                    <option value="">-- Seleccionar --</option>
                    <option th:each="color : ${colores}" th:value="${color.etiqueta}" th:text="${color.etiqueta}"></option>
                </select>
                <input type="text" id="colorOtroInput" placeholder="Escribe el color" style="margin-top:0.5rem; display:none;">
                <input type="hidden" id="colorFinal" name="color">
            </div>

            <!-- 7. Subir foto -->
            <div class="form-group">
                <label>Subir Foto</label>
                <div class="custom-file-upload">
                    <input type="file" id="fileInput" name="imagenOriginal" accept="image/*">
                    <label for="fileInput" class="file-upload-btn">
                        <i class="fas fa-cloud-upload-alt"></i>
                        <span class="file-upload-text">Seleccionar imagen</span>
                    </label>
                    <span class="file-name" id="fileName">Ning칰n archivo seleccionado</span>
                </div>
                <input type="hidden" id="imagenRecortada" name="imagenRecortada">
            </div>

            <button type="submit" class="btn-black">A침adir al Armario</button>
        </form>
    </aside>

    <section class="gallery-panel">
        <div class="gallery-header">
            <h1>Mis Prendas</h1>
            <span class="count" th:text="${totalPrendas} + ' ART칈CULOS'">0 ART칈CULOS</span>
        </div>

        <!-- Barra de b칰squeda y filtros -->
        <form id="filtroForm" th:action="@{/armario/}" method="get" class="filters-bar">
            <div class="search-wrapper">
                <span class="icon"><i class="fas fa-search"></i></span>
                <input type="text" name="q" placeholder="Buscar por nombre (ej. Cami)"
                       th:value="${filtroNombre}">
            </div>

            <div>
                <select id="filtroTipoSelect" name="tipo" onchange="mostrarCategoriasYTallasFiltro()">
                    <option value="">Tipo</option>
                    <option value="superior" th:selected="${filtroTipo == 'superior'}">Parte superior</option>
                    <option value="inferior" th:selected="${filtroTipo == 'inferior'}">Parte inferior</option>
                    <option value="calzado" th:selected="${filtroTipo == 'calzado'}">Calzado</option>
                </select>
            </div>

            <!-- Categor칤a Superior -->
            <div id="divFiltroCatSuperior" class="hidden">
                <select id="categoriaSuperiorSelect">
                    <option value="">Categor칤a</option>
                    <option th:each="cat : ${categoriasSuperior}"
                            th:value="${cat.name()}"
                            th:text="${cat.etiqueta}"
                            th:selected="${filtroCategoria == cat.name()}">
                    </option>
                </select>
            </div>

            <!-- Categor칤a Inferior -->
            <div id="divFiltroCatInferior" class="hidden">
                <select id="categoriaInferiorSelect">
                    <option value="">Categor칤a</option>
                    <option th:each="cat : ${categoriasInferior}"
                            th:value="${cat.name()}"
                            th:text="${cat.etiqueta}"
                            th:selected="${filtroCategoria == cat.name()}">
                    </option>
                </select>
            </div>

            <!-- Categor칤a Calzado -->
            <div id="divFiltroCatCalzado" class="hidden">
                <select id="categoriaCalzadoSelect">
                    <option value="">Categor칤a</option>
                    <option th:each="cat : ${categoriasCalzado}"
                            th:value="${cat.name()}"
                            th:text="${cat.etiqueta}"
                            th:selected="${filtroCategoria == cat.name()}">
                    </option>
                </select>
            </div>

            <!-- Campo oculto que se enviar치 al backend con la categor칤a unificada -->
            <input type="hidden" id="categoriaUnificada" name="categoria">

            <!-- Talla (se rellena din치micamente seg칰n el tipo) -->
            <div id="divFiltroTalla" class="hidden">
                <select id="filtroTallaSelect" name="talla" th:attr="data-talla-seleccionada=${filtroTalla}">
                    <option value="">Talla</option>
                </select>
            </div>

            <div>
                <select name="marca">
                    <option value="">Marca</option>
                    <option th:each="marca : ${marcasFiltro}"
                            th:value="${marca}"
                            th:text="${marca}"
                            th:selected="${filtroMarca == marca}"></option>
                </select>
            </div>

            <div>
                <select name="color">
                    <option value="">Color</option>
                    <option th:each="
                    color : ${coloresFiltro}"
                            th:value="${color}"
                            th:text="${color}"
                            th:selected="${filtroColor == color}"></option>
                </select>
            </div>

            <div>
                <button type="submit" class="btn-black" style="padding:0.7rem 1.2rem; width:auto;">Filtrar</button>
            </div>
        </form>

        <div class="wardrobe-grid" th:if="${prendas != null and !prendas.isEmpty()}">

            <article class="garment-card" th:each="prenda : ${prendas}">
                <div class="card-img">
                    <!-- Caso con imagen -->
                    <img th:if="${prenda.dirImagen != null and !#strings.isEmpty(prenda.dirImagen)}"
                         th:src="${prenda.dirImagen}"
                         alt="Prenda"
                         onerror="this.onerror=null;this.src='/images/placeholder_cloth.png';">

                    <!-- Caso sin imagen: icono seg칰n tipo -->
                    <div class="card-img-placeholder"
                         th:if="${prenda.dirImagen == null or #strings.isEmpty(prenda.dirImagen)}">
                        <span th:if="${prenda instanceof T(com.nada.nada.data.model.PrendaSuperior)}">游녴</span>
                        <span th:if="${prenda instanceof T(com.nada.nada.data.model.PrendaInferior)}">游녰</span>
                        <span th:if="${prenda instanceof T(com.nada.nada.data.model.PrendaCalzado)}">游</span>

                        <span class="label"
                              th:if="${prenda instanceof T(com.nada.nada.data.model.PrendaSuperior)}">Parte superior</span>
                        <span class="label"
                              th:if="${prenda instanceof T(com.nada.nada.data.model.PrendaInferior)}">Parte inferior</span>
                        <span class="label"
                              th:if="${prenda instanceof T(com.nada.nada.data.model.PrendaCalzado)}">Calzado</span>
                    </div>

                    <button type="button" class="delete-btn" title="Eliminar"
                            th:attr="data-prenda-id=${prenda.id}, data-prenda-nombre=${prenda.nombre}"
                            onclick="event.stopPropagation(); abrirModalEliminar(this);">
                        <i class="fas fa-times"></i>
                    </button>
                </div>

                <div class="card-details">
                    <h3 class="card-nombre" th:text="${prenda.nombre}">Nombre Prenda</h3>
                    <div class="card-meta">
                        <span class="card-marca" th:text="${prenda.marca}">MARCA</span>
                        <span class="card-talla" th:text="${prenda.talla}">TALLA</span>
                    </div>

                    <div class="badge card-badge-superior"
                         th:if="${prenda instanceof T(com.nada.nada.data.model.PrendaSuperior)}"
                         th:text="${prenda.categoria.etiqueta}"></div>
                    <div class="badge card-badge-inferior"
                         th:if="${prenda instanceof T(com.nada.nada.data.model.PrendaInferior)}"
                         th:text="${prenda.categoriaInferior.etiqueta}"></div>
                    <div class="badge card-badge-calzado"
                         th:if="${prenda instanceof T(com.nada.nada.data.model.PrendaCalzado)}"
                         th:text="${prenda.categoria.etiqueta}"></div>

                    <span class="card-id" th:text="${prenda.id}" style="display:none;"></span>
                    <span class="card-color" th:text="${prenda.color}" style="display:none;"></span>
                </div>
            </article>

        </div>

        <div class="empty-state" th:if="${prendas == null or prendas.isEmpty()}">
            <p>Tu armario est치 vac칤o. A침ade tu primera prenda desde el panel izquierdo.</p>
        </div>
    </section>

</main>

<!-- Modal edici칩n prenda -->
<div id="editModalOverlay" class="edit-modal-overlay">
    <div class="edit-modal">
        <div class="edit-modal-image">
            <img id="editModalImage" src="" alt="Prenda" style="width:100%; height:100%; object-fit:cover;">
        </div>
        <div class="edit-modal-content">
            <h2>Editar prenda</h2>
            <form id="editPrendaForm" th:action="@{/armario/actualizar}" method="post">
                <input type="hidden" name="id" id="editId">
                <input type="hidden" name="tipoPrenda" id="editTipoPrenda">

                <div class="form-group">
                    <label for="editNombre">Nombre</label>
                    <input type="text" id="editNombre" name="nombre" required>
                </div>

                <div class="form-group form-group-inline">
                    <div class="form-group" style="flex:1;">
                        <label for="editMarca">Marca</label>
                        <select id="editMarcaSelect">
                            <option value="" disabled selected>-- Seleccionar --</option>
                            <option th:each="marca : ${marcas}" th:value="${marca.etiqueta}" th:text="${marca.etiqueta}"></option>
                        </select>
                        <input type="text" id="editMarcaOtraInput" placeholder="Escribe la marca" style="margin-top:0.5rem; display:none;">
                        <input type="hidden" id="editMarca" name="marca">
                    </div>
                    <div class="form-group" style="flex:1;">
                        <label for="editTalla">Talla</label>
                        <!-- Select de talla en el modal, se rellena por JS seg칰n tipo -->
                        <select id="editTalla" name="talla" required>
                            <option value="" disabled selected>-- Seleccionar --</option>
                        </select>
                    </div>
                </div>

                <div class="form-group">
                    <label for="editColor">Color</label>
                    <select id="editColorSelect">
                        <option value="" disabled selected>-- Seleccionar --</option>
                        <option th:each="color : ${colores}" th:value="${color.etiqueta}" th:text="${color.etiqueta}"></option>
                    </select>
                    <input type="text" id="editColorOtraInput" placeholder="Escribe el color" style="margin-top:0.5rem; display:none;">
                    <input type="hidden" id="editColor" name="color">
                </div>

                <div id="editModalError" style="display:none; color:#c0392b; font-size:0.8rem; margin-top:0.5rem;"></div>

                <div class="edit-modal-actions">
                    <button type="button" class="btn-outline" id="closeEditModalBtn">Cancelar</button>
                    <button type="submit" class="btn-primary">Guardar cambios</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal/popup para recorte -->
<div id="cropModal" class="crop-modal-overlay">
    <div class="crop-modal">
        <div class="crop-modal-header">
            <h3>Ajusta el recorte</h3>
            <p>Mueve el cuadro rojo para elegir el 치rea a recortar. Se guardar치 a 800x800px.</p>
        </div>
        <div class="crop-modal-canvas-container">
            <canvas id="cropCanvas"></canvas>
        </div>
        <div class="crop-modal-actions">
            <button type="button" id="cancelCropBtn" class="btn-outline">Cancelar</button>
            <button type="button" id="confirmCropBtn" class="btn-primary">
                <i class="fas fa-crop-alt"></i> Aplicar recorte
            </button>
        </div>
    </div>
</div>

<!-- Modal de confirmaci칩n de eliminaci칩n -->
<div id="deleteModalOverlay" class="edit-modal-overlay" style="display:none;">
    <div class="edit-modal" style="max-width: 550px; grid-template-columns: 1fr;">
        <div class="edit-modal-content">
            <h2 style="margin-bottom: 1rem; color: #c0392b;">
                <i class="fas fa-exclamation-triangle" style="margin-right: 0.5rem;"></i>
                Confirmar eliminaci칩n
            </h2>

            <p style="margin-bottom: 1rem; font-size: 0.95rem; line-height: 1.6;">
                쮼st치s seguro de que deseas eliminar la prenda <strong id="deletePrendaNombre"></strong>?
            </p>

            <div id="deleteConjuntosInfo" style="display: none; background: #fff3cd; border-left: 4px solid #ffc107; padding: 1rem; margin-bottom: 1rem;">
                <p style="margin: 0 0 0.5rem 0; font-weight: 600; color: #856404;">
                    <i class="fas fa-info-circle" style="margin-right: 0.5rem;"></i>
                    Esta acci칩n tambi칠n eliminar치 <span id="deleteConjuntosCantidad">0</span> conjunto(s):
                </p>
                <ul id="deleteConjuntosLista" style="margin: 0; padding-left: 1.5rem; color: #856404; font-size: 0.9rem;">
                </ul>
            </div>

            <div id="deleteNoConjuntosInfo" style="display: none; background: #d1ecf1; border-left: 4px solid #17a2b8; padding: 1rem; margin-bottom: 1rem;">
                <p style="margin: 0; color: #0c5460; font-size: 0.9rem;">
                    <i class="fas fa-check-circle" style="margin-right: 0.5rem;"></i>
                    Esta prenda no forma parte de ning칰n conjunto.
                </p>
            </div>

            <p style="margin-bottom: 1.5rem; font-size: 0.85rem; color: #666; font-style: italic;">
                Esta acci칩n no se puede deshacer.
            </p>

            <div class="edit-modal-actions" style="margin-top: 0;">
                <button type="button" class="btn-outline" id="cancelDeleteBtn">Cancelar</button>
                <button type="button" class="btn-primary" id="confirmDeleteBtn" style="background: #c0392b; border-color: #c0392b;">
                    <i class="fas fa-trash" style="margin-right: 0.5rem;"></i>
                    Eliminar
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Chat Widget -->
<div th:replace="~{fragments/chat-widget :: chatWidget}"></div>

<!-- Scripts del chat -->
<script th:src="@{/js/chat-widget.js}"></script>

<script th:src="@{/js/prenda.js}"></script>
</body>
</html>

